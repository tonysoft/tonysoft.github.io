<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>vega in polymer demo</title>


    <script type="module">
      import 'https://unpkg.com/@webcomponents/shadycss/entrypoints/apply-shim.js';
    </script>

    <link rel="stylesheet" href="https://unpkg.com/tonysoft@^1.3.1/workoutTimer.css">


    <script type="module" src="https://unpkg.com/tonysoft@^1.3.1/digital-time-piece.js"></script>
    <script type="module" src="https://unpkg.com/tonysoft@^1.2.6/vega-container.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>

    <script src="https://unpkg.com/tonysoft@^1.3.1/panzoom.min.js"></script>

    <script src="https://unpkg.com/tonysoft@^1.3.1/utilities.js"></script>
    <script src="https://unpkg.com/tonysoft@^1.3.1/workoutTimerLogic.js"></script>

    <script>
      window.addEventListener("resize", windowResize);

      window.onload = function() {
       load();
      }

      var vegaViews = [];
      var vegaContainers = [];

      function load() {
        var demos = ["./vegaTest/tree-layout.vg.json", "./vegaTest/airports.vg.json", "./vegaTest/bar-chart.vg.json", "./vegaTest/sunburst.vg.json"]
        var views = document.querySelectorAll(".vegaView");
        var viewIndex = 0;
        var rendered = 0;
        views.forEach(function(view) {
          if (view.vegaRenderCallback !== undefined) {
            view.vegaRenderCallback = vegaRenderCallback;
            fetch(demos[viewIndex])
              .then(res => res.json())
              .then(spec => {
                view.vegaSpecJSON = spec
              })
              .catch(err => console.error(err));
            // view.vegaSpec = demos[viewIndex];
          } else {
            rendered++;
          }
          viewIndex++;
          function vegaRenderCallback(vegaContainer, view) {
            vegaViews.push(view);
            vegaContainers.push(vegaContainer);
            rendered++;
            if (rendered === views.length) {
                demoSetup();
            }
          }
        })

      }

      function demoSetup() {
        var vegaContainer = document.querySelector(".barChartDemo");
        windowResize();
        var fullScreen = document.querySelector(".demoWrapper");
        fullScreen.style.opacity = 1.0;
        var element = document.querySelector('#panZoomContainer');
        panzoom(element, {
          zoomDoubleClickSpeed: 1, 
        });
        fetch("./vegaTest/bar-chart.data.json")
          .then(res => res.json())
          .then(data => {
            setupBarChartDataUpdate(data, vegaContainer);
          })
        fetch("./apiRequests/metroRouting.json")
          .then(res => res.json())
          .then(data => {
            metroRoutingRequestTemplate = data;
          })

        vegaContainers.forEach(function(container) {
          container.addEventListener('interaction', function(e) {
            handleVegaInteraction(e)
          });
        })
      }

      function setupBarChartDataUpdate(barChartData, vegaContainer) {
        // vegaContainer.vegaView.addEventListener('click', function(event, item) {
        //   console.log(item.datum);
        // });
        var digitalClock = document.querySelector("#digitalClock");
        digitalClock.start();
        digitalClock.addEventListener('update', function(e) {
          var seconds = e.detail.seconds;
          if (!(seconds%10)) {
            barChartData.forEach(function(bar) {
              bar.amount = Math.max(Math.floor(Math.random() * 100), 4);
            })
            vegaContainer.vegaData = barChartData;
            vegaContainer.vegaDataSetName = "table";
            // vegaContainer.vegaUpdate("table", barChartData, true);
          }
        })
      }

      function handleVegaInteraction(e) {
        var detail = e.detail;
        var item = detail.item;
        if (!item || !item.datum) {
          return;
        }
        var interaction = detail.interaction;
        switch (interaction) {
          case "click":
            handleVegaClick(e)
            break;
          case "mouseover":
            handleVegaMouseover(e)
            break;
          case "mouseout":
            handleVegaMouseout(e)
            break;
        }
      }

      function handleVegaClick(e) {
        var detail = e.detail;
        var item = detail.item;
        var event = detail.rawEvent;
        var category = detail.category;
        switch (category) {
          case "MetroMap":
            metroMapClick(e);
            break;
          default:
            showItem(item, event);
            break;
        }
      }

      function handleVegaMouseover(e) {
        var detail = e.detail;
        var item = detail.item;
        var event = detail.rawEvent;
        var category = detail.category;
        switch (category) {
          case "MetroMap":
            metroMapHoverNode(e);
            break;
          default:
            break;
        }
      }

      function handleVegaMouseout(e) {
        var detail = e.detail;
        var item = detail.item;
        var event = detail.rawEvent;
        var category = detail.category;
        switch (category) {
          case "MetroMap":
            var metroMapHeader = document.querySelector("#MetroMapHeader");
            metroMapHeader.innerText = "Metro Map";
            break;
          default:
            break;
        }
      }

      function metroMapClick(e) {
        var detail = e.detail;
        var item = detail.item;
        var event = detail.rawEvent;
        var entity = item.datum.entity;
        switch (entity) {
          case "metroRoutingNode":
            if (event.ctrlKey) {
              showItem(item, event);
            } else {
              metroRoutingUpdate(item.datum.id);
            }
            break;
          default:
            showItem(item, event);
            break;
        }
      }

      function metroMapHoverNode(e) {
        var detail = e.detail;
        var item = detail.item;
        var entity = item.datum.entity;
        switch (entity) {
          case "metroRoutingNode":
            var view = detail.view;
            var metroMap = view.data("tree");
            var metro = item.datum.id;
            var pathToOrigin = buildMetroPathToOrigin(metro, metroMap);
            var metroMapHeader = document.querySelector("#MetroMapHeader");
            metroMapHeader.innerText = pathToOrigin;
            break;
        }
      }

      function buildMetroPathToOrigin(metro, metroMap) {
        var pathToOrigin = "";
        var metroMapMap = {};
        metroMap.forEach(function(metro) {
          metroMapMap[metro.id] = metro;
        })
        var targetMetro = metroMapMap[metro];
        pathToOrigin += targetMetro.name;
        while (targetMetro.parent) {
          targetMetro = metroMapMap[targetMetro.parent];
          if (targetMetro) {
            pathToOrigin += " >> " + targetMetro.name;
          }
        }
        return pathToOrigin;
      }

      function showItem(item, event) {
          var itemContents = "";
          for (var prop in item.datum) {
            itemContents += prop + ": " + item.datum[prop] + "\n"
          }
          if (event.ctrlKey) {
            alert(itemContents);
          }
          console.log(item.datum);
      }

      var metroRoutingRequestTemplate = null;
      function metroRoutingUpdate(metro) {
        if (!metro) {
          return;
        }
        var metroRoutingRequest = JSON.stringify(metroRoutingRequestTemplate);
        metroRoutingRequest = metroRoutingRequest.replace("${metro}", metro);
        metroRoutingRequest = JSON.parse(metroRoutingRequest);
        apiRequest("http://localhost:8090", "executeWorkflow", metroRoutingRequest, function(metroRouting) {
          var treeContainer = document.querySelector(".treeDemo");
          var sunburstContainer = document.querySelector(".sunburstDemo");
          treeContainer.vegaUpdate("tree", metroRouting, true, function(vegaContainer, view) {
            // Any postprocessing after an update
          });
          sunburstContainer.vegaUpdate("tree", metroRouting, true, function(vegaContainer, view) {
            // Any postprocessing after an update
          });
        });
      }

      function clickMetro(e) {
        var metro = e.srcElement.textContent;
        if (metro) {
          metroRoutingUpdate(metro);
        }
      }

      function clickTest(e) {
        console.log(e.srcElement);
      }

    </script>


    <style>
      .zoomPanBox {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
      }
      .testBox {
        position: absolute;
        top: 0px;
        left: 0px;
      }
    </style>

    <custom-style>
      <style is="custom-style">
      </style>
    </custom-style>
  </head>
  <body>
    <!-- <div oncontextmenu="cancelDefault(event)" onclick="eat(event)" onmousedown="eat(event)" onmouseup="eat(event)" class="fullScreen"></div> -->
    <div id="panZoomContainer" oncontextmenu="cancelDefault(event)" onclick="eat(event)" onmousedown="eat(event)" onmouseup="eat(event)" class="fullScreen demoWrapper" style="opacity: 0.0;">
      <div class="topLeft">
        <vega-container id="MetroMap" category="MetroMap" best-fit class="vegaView treeDemo">
          <h1 id="MetroMapHeader" slot="header" class="centered bigText">Metro Map</h1>
          <div slot="content"></div>
          <h1 slot="footer" class="centered">How a Network Routes to various Worldwide Locations...</h1>
        </vega-container>
      </div>
      <div class="topRight">
        <vega-container id="AirportRouting" category="AirportRouting" best-fit class="vegaView">
          <h1 slot="header" class="centered">Routing from Airport to Airport</h1>
          <div slot="content"></div>
          <h1 slot="footer" class="centered">The Larger the Dot, the more Flights...</h1>
        </vega-container>
      </div>
      <div class="bottomRight">
        <vega-container id="BarChart" category="BarChart" best-fit class="vegaView barChartDemo">
          <div slot="header" class="centered">Bar Chart</div>
          <div slot="content"></div>
          <div slot="footer" class="centered">
            <digital-time-piece id="digitalClock" size="25" class="halfWidth" style="display: inline-block;"></digital-time-piece>
          </div>
        </vega-container>
      </div>
      <div class="bottomLeft">
        <vega-container id="MetroMapSunburst" category="MetroMap" best-fit class="vegaView sunburstDemo">
          <h1 slot="header" class="centered">Sunburst Chart</h1>
          <div slot="content"></div>
          <h2 slot="footer" class="centered">Another way of representing Tree Data...</h2>
        </vega-container>
      </div>
    </div>
  </body>
</html>
 